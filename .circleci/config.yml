version: 2.1

parameters:
  maintainer:
    type: string
    default: support@solarbotics.com

  repo:
    type: string
    default: solarbotics/arduino-cli

executors:
  python:
    docker:
      - image: circleci/python:3.9
        auth:
          username: $DOCKER_HUB_USERNAME
          password: $DOCKER_HUB_PASSWORD

commands:
  initialize:
    parameters:
      version:
        type: string
        default: 20.10.2

    steps:
      - checkout

      - setup_remote_docker:
          version: << parameters.version >>

      - run:
          name: Docker Hub login
          command: |
            if [ -n "$DOCKER_HUB_USERNAME" ]; then
              docker login --username $DOCKER_HUB_USERNAME --password $DOCKER_HUB_PASSWORD
            else
              echo "Missing Docker Hub credentials"
              exit 1
            fi

      - run:
          name: Install dependencies
          command: |
            pip3 install -r requirements.txt

jobs:
  base:
    executor: python

    steps:
      - initialize

      - run:
         name: Build images
         command: |
           mkdir -p tags
           python3 docker-arduino-cli.py \
            build \
              --username $DOCKER_HUB_USERNAME \
              --password $DOCKER_HUB_PASSWORD \
              -r << pipeline.parameters.repo >> \
              -m << pipeline.parameters.maintainer >> \
            base \
              matrix.json > tags/base.json

      - store_artifacts:
          path: tags/base.json

      - persist_to_workspace:
          root: .
          paths:
            - tags/*

  core:
    executor: python

    parameters:
      index_url:
        type: string
      package:
        type: string
      platform:
        type: string

    steps:
      - initialize

      - attach_workspace:
          at: .

      - run:
         name: Build images
         command: |
           mkdir -p tags
           python3 docker-arduino-cli.py \
            build \
              --username $DOCKER_HUB_USERNAME \
              --password $DOCKER_HUB_PASSWORD \
              -r << pipeline.parameters.repo >> \
              -m << pipeline.parameters.maintainer >> \
            core \
              --package << parameters.package >> \
              --platform << parameters.platform >> \
              matrix.json tags/base.json > tags/<< parameters.package >>-<< parameters.platform >>.json

      - store_artifacts:
          path: tags/<< parameters.package >>-<< parameters.platform >>.json

  update:
    executor: python

    parameters:
      window:
        type: integer
      deploy_key:
        type: string

    steps:
      - initialize

      - add_ssh_keys:
          fingerprints:
            - << parameters.deploy_key >>

      - run:
         name: Update matrix
         command: |
           python3 docker-arduino-cli.py update --token $GITHUB_TOKEN --days << parameters.window >> matrix.json
           if [ -f "message.txt" ]; then
             git commit -F message.txt matrix.json && git push
           else
             echo "No matrix changes to commit"
           fi

workflows:
  version: 2

  commit:
    jobs:
      - base:
          context:
            - dockerhub

      - core:
          name: "arduino:avr"
          package: arduino
          platform: avr
          requires:
            - base
          context:
            - dockerhub

      - core:
          name: "arduino:sam"
          package: arduino
          platform: sam
          requires:
            - base
          context:
            - dockerhub

      - core:
          name: "arduino:samd"
          package: arduino
          platform: samd
          requires:
            - base
          context:
            - dockerhub

      - core:
          name: "esp8266:esp8266"
          package: esp8266
          platform: esp8266
          requires:
            - base
          context:
            - dockerhub

      - core:
          name: "esp32:esp32"
          package: esp32
          platform: esp32
          requires:
            - base
          context:
            - dockerhub

  update:
    jobs:
      - update:
          name: update
          window: 365
          deploy_key: "bd:50:c1:71:98:ae:e8:f4:78:f5:c0:a7:b2:0d:6d:59"
          context:
            - github_docker_arduino_cli
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - master
